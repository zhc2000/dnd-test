<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>âœ¨ D&D 5e äººç‰©åˆ›å»ºå™¨</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background-image: url('https://images.unsplash.com/photo-1553877619-7a4b3d2f8a5e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.93);
      backdrop-filter: blur(6px);
      border-radius: 18px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
      overflow: hidden;
      padding: 24px;
    }

    h1 {
      text-align: center;
      margin-bottom: 24px;
      color: #2c3e50;
      font-size: 28px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    h2 {
      margin: 20px 0 12px;
      color: #3498db;
      font-size: 20px;
    }

    .form-group {
      display: flex;
      align-items: center;
      margin: 14px 0;
    }
    .form-group label {
      width: 100px;
      font-weight: 600;
      color: #2c3e50;
    }
    .form-group input,
    .form-group select {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s;
      display: inline-block;
      margin: 8px 4px;
    }
    button:hover:not(:disabled) {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
    }

    .rolled-abilities {
      display: flex;
      gap: 12px;
      margin: 16px 0;
      flex-wrap: wrap;
    }
    .ability-token {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      border: 2px dashed #64b5f6;
      padding: 12px 16px;
      border-radius: 10px;
      cursor: grab;
      user-select: none;
      font-weight: bold;
      font-size: 18px;
      min-width: 50px;
      text-align: center;
      transition: transform 0.2s;
    }
    .ability-token:hover {
      transform: scale(1.05);
    }
    .ability-token.dragging {
      opacity: 0.6;
    }

    .ability-slots {
      margin-top: 20px;
    }
    .ability-slot {
      display: flex;
      align-items: center;
      margin: 10px 0;
      background: #f8f9fa;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      transition: background 0.3s;
    }
    .ability-slot.filled {
      background: #e8f5e9;
      border-color: #81c784;
    }
    .ability-slot .name {
      width: 80px;
      font-weight: 700;
      color: #2c3e50;
    }
    .ability-slot .value {
      min-width: 50px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      color: #27ae60;
    }
    .ability-slot .modifier {
      margin-left: 12px;
      color: #7f8c8d;
      font-size: 16px;
    }

    /* =============== è§’è‰²å¡æ ·å¼ =============== */
    #characterCard {
      display: none;
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-top: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    #characterCard h2 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 16px;
    }
    .card-row {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
    }
    .card-label {
      font-weight: bold;
      color: #34495e;
    }
    .card-value {
      color: #2c3e50;
    }
    .abilities-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 12px;
    }
    .ability-box {
      text-align: center;
      padding: 10px;
      background: #f1f8e9;
      border-radius: 8px;
    }
    .ability-name {
      font-size: 14px;
      color: #555;
    }
    .ability-score {
      font-size: 24px;
      font-weight: bold;
      color: #27ae60;
    }
    .ability-mod {
      font-size: 14px;
      color: #7f8c8d;
    }

    @media (max-width: 600px) {
      .container { padding: 16px; }
      .form-group { flex-direction: column; align-items: stretch; }
      .form-group label { margin-bottom: 6px; }
      .rolled-abilities { justify-content: center; }
      .abilities-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>

<div class="container">
  <h1>âœ¨ D&D 5e äººç‰©åˆ›å»ºå™¨</h1>

  <div class="form-group">
    <label>è§’è‰²åç§°ï¼š</label>
    <input type="text" id="charName" placeholder="å¦‚ï¼šç”˜é“å¤«" />
  </div>
  <div class="form-group">
    <label>ç©å®¶å§“åï¼š</label>
    <input type="text" id="playerName" placeholder="ä½ çš„åå­—" />
  </div>
  <div class="form-group">
    <label>ç§æ—ï¼š</label>
    <select id="raceSelect">
      <option value="">-- åŠ è½½ä¸­ --</option>
    </select>
  </div>
  <div class="form-group">
    <label>èŒä¸šï¼š</label>
    <select id="occSelect">
      <option value="">-- åŠ è½½ä¸­ --</option>
    </select>
  </div>
  <div class="form-group">
    <label>ç­‰çº§ï¼š</label>
    <select id="levelSelect">
      <script>
        for (let i = 1; i <= 20; i++) document.write(`<option value="${i}">${i}</option>`);
      </script>
    </select>
  </div>

  <button onclick="rollAbilities()">ğŸ² æ·éª°ç”Ÿæˆå…­ç»´å±æ€§</button>

  <div id="abilitiesSection" style="display:none;">
    <h2>å¯ç”¨å±æ€§å€¼ï¼ˆæ‹–æ‹½åˆ°ä¸‹æ–¹æ§½ä½ï¼‰</h2>
    <div id="rolledContainer" class="rolled-abilities"></div>

    <h2>åˆ†é…å±æ€§</h2>
    <div class="ability-slots" id="abilitySlots"></div>

    <button onclick="applyRacialBonus()" id="bonusBtn">ğŸŒŸ åº”ç”¨ç§æ—åŠ å€¼</button>
    <button onclick="generateCharacter()">âœ… ç”Ÿæˆè§’è‰²</button>
  </div>

  <!-- ç²¾ç¾è§’è‰²å¡ -->
  <div id="characterCard">
    <h2 id="cardCharName">è§’è‰²å</h2>
    <div class="card-row">
      <span class="card-label">ç©å®¶ï¼š</span>
      <span class="card-value" id="cardPlayerName"></span>
    </div>
    <div class="card-row">
      <span class="card-label">ç§æ— / èŒä¸š / ç­‰çº§ï¼š</span>
      <span class="card-value" id="cardRaceClassLevel"></span>
    </div>
    <div class="card-row">
      <span class="card-label">ä½“å‹ / é€Ÿåº¦ï¼š</span>
      <span class="card-value" id="cardSizeSpeed"></span>
    </div>
    <div class="card-row">
      <span class="card-label">ç”Ÿå‘½å€¼ï¼ˆHPï¼‰ï¼š</span>
      <span class="card-value" id="cardHP"></span>
    </div>
    <div class="card-row" style="font-size:14px;color:#7f8c8d;">
      <span>ï¼ˆå«ä½“è´¨è°ƒæ•´å€¼ï¼‰</span>
    </div>

    <h3 style="margin-top: 20px;">å±æ€§</h3>
    <div class="abilities-grid" id="cardAbilitiesGrid"></div>

    <div style="margin-top: 20px; text-align: center;">
      <button onclick="saveCharacterCardAsImage()">ğŸ–¼ï¸ ä¿å­˜è§’è‰²å¡ä¸ºå›¾ç‰‡</button>
    </div>
  </div>
</div>

<!-- å¼•å…¥ html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
// ================== æ•°æ®ç±» ==================
class Race {
  constructor(name, size, speed) {
    this.name = name;
    this.size = size;
    this.speed = parseInt(speed);
  }
}
class Occupation {
  constructor(name, hitDieSize) {
    this.name = name;
    this.hitDieSize = parseInt(hitDieSize); // å¦‚ 10 è¡¨ç¤º d10
  }
}

// ================== å…¨å±€çŠ¶æ€ ==================
let races = [];
let occupations = [];
let rolledAbilities = [];
let assigned = [null, null, null, null, null, null];
let racialBonusApplied = false;
const abilityNames = ['åŠ›é‡', 'æ•æ·', 'ä½“è´¨', 'æ™ºåŠ›', 'æ„ŸçŸ¥', 'é­…åŠ›'];

// ================== åˆå§‹åŒ– ==================
window.onload = () => {
  const mockRaceData = `äººç±» ä¸­å‹ 30
çŸ®äºº ä¸­å‹ 25
åŠèº«äºº å°å‹ 25
åŠç²¾çµ ä¸­å‹ 30
ç²¾çµ ä¸­å‹ 30
é¾™è£” ä¸­å‹ 30
åŠå…½äºº ä¸­å‹ 30
æå¤«æ— ä¸­å‹ 30`;
  const mockOccData = `æˆ˜å£« 10
åŸæ¸¸è¯—äºº 8
é‡è›®äºº 12
æ³•å¸ˆ 6
æœ¯å£« 6
åœ£æ­¦å£« 10
æ¸¸ä¾  10
é‚ªæœ¯å¸ˆ 8
æ¸¸è¡è€… 8
æ­¦åƒ§ 8`;

  races = mockRaceData.trim().split('\n').map(line => {
    const [name, size, speed] = line.split(' ');
    return new Race(name, size, speed);
  });
  occupations = mockOccData.trim().split('\n').map(line => {
    const [name, hd] = line.split(' ');
    return new Occupation(name, hd);
  });

  populateSelects();
  renderAbilitySlots();
};

function populateSelects() {
  const raceSel = document.getElementById('raceSelect');
  const occSel = document.getElementById('occSelect');
  raceSel.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
  occSel.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';

  races.forEach(r => {
    const opt = document.createElement('option');
    opt.value = r.name;
    opt.textContent = r.name;
    raceSel.appendChild(opt);
  });
  occupations.forEach(o => {
    const opt = document.createElement('option');
    opt.value = o.name;
    opt.textContent = o.name;
    occSel.appendChild(opt);
  });
}

function renderAbilitySlots() {
  const container = document.getElementById('abilitySlots');
  container.innerHTML = '';
  abilityNames.forEach((name, i) => {
    const slot = document.createElement('div');
    slot.className = 'ability-slot';
    slot.id = `slot-${i}`;
    slot.innerHTML = `
      <span class="name">${name}</span>
      <span class="value">?</span>
      <span class="modifier"></span>
    `;
    container.appendChild(slot);
  });
  setupDropZones();
}

// ================== æ·éª° ==================
function roll4d6DropLowest() {
  const rolls = Array.from({ length: 4 }, () => Math.floor(Math.random() * 6) + 1);
  return rolls.sort((a, b) => a - b).slice(1).reduce((a, b) => a + b, 0);
}

function rollAbilities() {
  rolledAbilities = Array.from({ length: 6 }, (_, idx) => ({
    id: idx,
    value: roll4d6DropLowest()
  }));
  renderRolledAbilities();
  document.getElementById('abilitiesSection').style.display = 'block';
  assigned = [null, null, null, null, null, null];
  racialBonusApplied = false;
  updateAssignUI();
}

function renderRolledAbilities() {
  const container = document.getElementById('rolledContainer');
  container.innerHTML = '';
  rolledAbilities.forEach(item => {
    const token = document.createElement('div');
    token.className = 'ability-token';
    token.textContent = item.value;
    token.draggable = true;

    token.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', item.id.toString());
      token.classList.add('dragging');
    });
    token.addEventListener('dragend', () => {
      token.classList.remove('dragging');
    });

    container.appendChild(token);
  });
}

// ================== æ‹–æ‹½åˆ†é… ==================
function setupDropZones() {
  const slots = document.querySelectorAll('.ability-slot');
  slots.forEach((slot, idx) => {
    slot.addEventListener('dragover', (e) => e.preventDefault());
    slot.addEventListener('drop', (e) => {
      e.preventDefault();
      const idStr = e.dataTransfer.getData('text/plain');
      if (!idStr) return;
      const id = parseInt(idStr);

      const item = rolledAbilities.find(x => x.id === id);
      if (!item) return;

      const alreadyUsed = assigned.some(a => a && a.id === id);
      if (alreadyUsed) {
        alert('è¯¥éª°å­ç»“æœå·²è¢«ä½¿ç”¨ï¼');
        return;
      }

      for (let i = 0; i < 6; i++) {
        if (assigned[i] && assigned[i].id === id) assigned[i] = null;
      }

      assigned[idx] = item;
      updateAssignUI();
    });
  });
}

// ================== å·¥å…·å‡½æ•° ==================
function calcModifier(score) {
  if (score >= 10) return Math.floor((score - 10) / 2);
  else return -Math.ceil((10 - score) / 2);
}

function updateAssignUI() {
  for (let i = 0; i < 6; i++) {
    const slot = document.getElementById(`slot-${i}`);
    const valueEl = slot.querySelector('.value');
    const modEl = slot.querySelector('.modifier');

    if (assigned[i] !== null) {
      const val = assigned[i].value;
      valueEl.textContent = val;
      const mod = calcModifier(val);
      modEl.textContent = mod >= 0 ? `(+${mod})` : `(${mod})`;
      slot.classList.add('filled');
    } else {
      valueEl.textContent = '?';
      modEl.textContent = '';
      slot.classList.remove('filled');
    }
  }

  const bonusBtn = document.getElementById('bonusBtn');
  bonusBtn.disabled = racialBonusApplied || assigned.some(v => v === null);
}

// ================== ç§æ—åŠ å€¼ ==================
function applyRacialBonus() {
  const raceName = document.getElementById('raceSelect').value;
  const race = races.find(r => r.name === raceName);
  if (!race) {
    alert('è¯·é€‰æ‹©æœ‰æ•ˆç§æ—ï¼');
    return;
  }
  if (assigned.some(v => v === null)) {
    alert('è¯·å…ˆå®Œæˆæ‰€æœ‰å±æ€§åˆ†é…ï¼');
    return;
  }

  const isHuman = race.name === 'äººç±»';
  if (isHuman) {
    for (let i = 0; i < 6; i++) assigned[i] = { ...assigned[i], value: assigned[i].value + 1 };
  } else {
    const plus2Idx = prompt(`è¯·é€‰æ‹©è¦+2çš„å±æ€§ï¼ˆ0-5ï¼‰:\n0=åŠ›é‡,1=æ•æ·,2=ä½“è´¨,3=æ™ºåŠ›,4=æ„ŸçŸ¥,5=é­…åŠ›`);
    const plus1Idx = prompt(`è¯·é€‰æ‹©è¦+1çš„å±æ€§ï¼ˆ0-5ï¼Œä¸èƒ½ä¸+2ç›¸åŒï¼‰`);
    if (plus2Idx === null || plus1Idx === null) return;

    const p2 = parseInt(plus2Idx), p1 = parseInt(plus1Idx);
    if (isNaN(p2) || isNaN(p1) || p2 < 0 || p2 > 5 || p1 < 0 || p1 > 5 || p2 === p1) {
      alert('è¾“å…¥æ— æ•ˆï¼');
      return;
    }
    assigned[p2] = { ...assigned[p2], value: assigned[p2].value + 2 };
    assigned[p1] = { ...assigned[p1], value: assigned[p1].value + 1 };
  }

  racialBonusApplied = true;
  updateAssignUI();
  alert('âœ… ç§æ—åŠ å€¼å·²åº”ç”¨ï¼');
}

// ================== HP è®¡ç®—ï¼ˆD&D 5e è§„åˆ™ï¼‰==================
function calculateHitPoints(occupation, level, conModifier) {
  let total = 0;

  // 1çº§ï¼šå–ç”Ÿå‘½éª°æœ€å¤§å€¼ + ä½“è´¨è°ƒæ•´å€¼
  total += occupation.hitDieSize + conModifier;

  // 2çº§åˆ°å½“å‰ç­‰çº§ï¼šæ¯çº§æŠ•æ· 1dX + ä½“è´¨è°ƒæ•´å€¼
  for (let lvl = 2; lvl <= level; lvl++) {
    const roll = Math.floor(Math.random() * occupation.hitDieSize) + 1;
    total += roll + conModifier;
  }

  // HP è‡³å°‘ä¸º 1
  return Math.max(1, total);
}

// ================== ç”Ÿæˆè§’è‰²å¡ ==================
function generateCharacter() {
  if (assigned.some(v => v === null)) {
    alert('è¯·å®Œæˆå±æ€§åˆ†é…ï¼');
    return;
  }
  if (!racialBonusApplied) {
    alert('è¯·å…ˆåº”ç”¨ç§æ—åŠ å€¼ï¼');
    return;
  }

  const name = document.getElementById('charName').value.trim();
  const playerName = document.getElementById('playerName').value.trim();
  const raceName = document.getElementById('raceSelect').value;
  const occName = document.getElementById('occSelect').value;
  const level = parseInt(document.getElementById('levelSelect').value);

  if (!name || !playerName || !raceName || !occName) {
    alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µï¼');
    return;
  }

  const race = races.find(r => r.name === raceName);
  const occ = occupations.find(o => o.name === occName);
  const abilityValues = assigned.map(a => a.value);
  const conMod = calcModifier(abilityValues[2]); // ä½“è´¨æ˜¯ç¬¬3é¡¹ï¼ˆç´¢å¼•2ï¼‰

  // âœ… ä½¿ç”¨æ–°è§„åˆ™è®¡ç®— HP
  const hp = calculateHitPoints(occ, level, conMod);

  // å¡«å……è§’è‰²å¡
  document.getElementById('cardCharName').textContent = name;
  document.getElementById('cardPlayerName').textContent = playerName;
  document.getElementById('cardRaceClassLevel').textContent = `${race.name} / ${occ.name} / ${level}çº§`;
  document.getElementById('cardSizeSpeed').textContent = `${race.size} / ${race.speed}å°º`;
  document.getElementById('cardHP').textContent = `${hp} HP`;

  const grid = document.getElementById('cardAbilitiesGrid');
  grid.innerHTML = '';
  abilityNames.forEach((name, i) => {
    const box = document.createElement('div');
    box.className = 'ability-box';
    const mod = calcModifier(abilityValues[i]);
    box.innerHTML = `
      <div class="ability-name">${name}</div>
      <div class="ability-score">${abilityValues[i]}</div>
      <div class="ability-mod">${mod >= 0 ? '+' + mod : mod}</div>
    `;
    grid.appendChild(box);
  });

  document.getElementById('characterCard').style.display = 'block';
  document.getElementById('characterCard').scrollIntoView({ behavior: 'smooth' });
}

// ================== ä¿å­˜ä¸ºå›¾ç‰‡ ==================
function saveCharacterCardAsImage() {
  const card = document.getElementById('characterCard');
  html2canvas(card, {
    backgroundColor: '#ffffff',
    scale: 2,
    useCORS: true
  }).then(canvas => {
    const link = document.createElement('a');
    link.download = `${document.getElementById('charName').value || 'character'}_card.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
  });
}
</script>

</body>

</html>
